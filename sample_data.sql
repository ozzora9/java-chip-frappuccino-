-------------------------------------------------------------------------------
-- Cook+Pick Sample Schema + Data for Oracle (UTF-8)
-- Safe drop → create tables with IDENTITY, then insert minimal seed data.
-------------------------------------------------------------------------------

-- 0) Safe drop (ignore if not exists)
BEGIN EXECUTE IMMEDIATE 'DROP TABLE REVIEWS CASCADE CONSTRAINTS';        EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE RECIPE_STEPS CASCADE CONSTRAINTS';    EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE RECIPE_INGREDIENTS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE RECIPES CASCADE CONSTRAINTS';         EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE REFRIGERATOR_ITEMS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE INGREDIENTS CASCADE CONSTRAINTS';     EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE NOTIFICATIONS CASCADE CONSTRAINTS';   EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE MART_INTEGRATIONS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE MARTS CASCADE CONSTRAINTS';          EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE MEMBERS CASCADE CONSTRAINTS';        EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
-------------------------------------------------------------------------------
-- 1) Core tables
-------------------------------------------------------------------------------

CREATE TABLE MEMBERS (
  MEMBER_NO      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  NAME           VARCHAR2(100) NOT NULL,
  USER_ID        VARCHAR2(50) NOT NULL UNIQUE,
  PASSWORD_HASH  VARCHAR2(200) NOT NULL,
  EMAIL          VARCHAR2(150),
  PHONE          VARCHAR2(30),
  BIRTH_DATE     DATE,
  GENDER         CHAR(1),
  POINTS         NUMBER DEFAULT 0 NOT NULL,
  CREATED_AT     TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL
);

CREATE TABLE NOTIFICATIONS (
  NOTI_ID     NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  MEMBER_NO   NUMBER NOT NULL,
  MESSAGE     VARCHAR2(1000) NOT NULL,
  CREATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP,
  CONSTRAINT FK_NOTI_MEMBER FOREIGN KEY (MEMBER_NO)
    REFERENCES MEMBERS(MEMBER_NO) ON DELETE CASCADE
);

CREATE TABLE INGREDIENTS (
  INGREDIENT_ID       NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  NAME                VARCHAR2(100) NOT NULL UNIQUE,
  CATEGORY            VARCHAR2(50),
  AVG_SHELFLIFE_DAYS  NUMBER
);

CREATE TABLE REFRIGERATOR_ITEMS (
  ITEM_ID                NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  MEMBER_NO              NUMBER NOT NULL,
  INGREDIENT_ID          NUMBER NOT NULL,
  QUANTITY               VARCHAR2(50) DEFAULT '1개',
  PURCHASE_DATE          DATE NOT NULL,
  EXPIRATION_DATE        DATE,
  IS_EXPIRATION_UNKNOWN  CHAR(1) DEFAULT 'N' CHECK (IS_EXPIRATION_UNKNOWN IN ('Y','N')),
  CREATED_AT             TIMESTAMP DEFAULT SYSTIMESTAMP,
  CONSTRAINT FK_REF_MEMBER FOREIGN KEY (MEMBER_NO)
    REFERENCES MEMBERS(MEMBER_NO) ON DELETE CASCADE,
  CONSTRAINT FK_REF_INGREDIENT FOREIGN KEY (INGREDIENT_ID)
    REFERENCES INGREDIENTS(INGREDIENT_ID)
);

CREATE TABLE RECIPES (
  RECIPE_ID      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  TITLE          VARCHAR2(255) NOT NULL,
  DESCRIPTION    VARCHAR2(1000),
  AUTHOR_NO      NUMBER,
  IS_OFFICIAL    CHAR(1) DEFAULT 'N' CHECK(IS_OFFICIAL IN ('Y','N')),
  AVG_RATING     NUMBER(2,1) DEFAULT 0.0,
  RATING_COUNT   NUMBER DEFAULT 0,
  MAIN_IMAGE_URL VARCHAR2(1000),
  CREATED_AT     TIMESTAMP DEFAULT SYSTIMESTAMP,
  CONSTRAINT FK_RECIPE_AUTHOR FOREIGN KEY (AUTHOR_NO)
    REFERENCES MEMBERS(MEMBER_NO) ON DELETE SET NULL
);

CREATE TABLE RECIPE_INGREDIENTS (
  RECIPE_ID         NUMBER NOT NULL,
  INGREDIENT_ID     NUMBER NOT NULL,
  REQUIRED_QUANTITY VARCHAR2(100),
  PRIMARY KEY (RECIPE_ID, INGREDIENT_ID),
  CONSTRAINT FK_RI_RECIPE FOREIGN KEY (RECIPE_ID)
    REFERENCES RECIPES(RECIPE_ID) ON DELETE CASCADE,
  CONSTRAINT FK_RI_INGREDIENT FOREIGN KEY (INGREDIENT_ID)
    REFERENCES INGREDIENTS(INGREDIENT_ID)
);

CREATE TABLE RECIPE_STEPS (
  STEP_ID      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  RECIPE_ID    NUMBER NOT NULL,
  STEP_NUMBER  NUMBER NOT NULL,
  INSTRUCTION  VARCHAR2(2000) NOT NULL,
  IMAGE_URL    VARCHAR2(1000),
  CONSTRAINT FK_STEP_RECIPE FOREIGN KEY (RECIPE_ID)
    REFERENCES RECIPES(RECIPE_ID) ON DELETE CASCADE
);

CREATE TABLE REVIEWS (
  REVIEW_ID    NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  RECIPE_ID    NUMBER NOT NULL,
  MEMBER_NO    NUMBER NOT NULL,
  RATING       NUMBER(2,1) NOT NULL CHECK (RATING BETWEEN 0.5 AND 5.0),
  COMMENT_TEXT VARCHAR2(1000),
  CREATED_AT   TIMESTAMP DEFAULT SYSTIMESTAMP,
  CONSTRAINT FK_REVIEW_RECIPE FOREIGN KEY (RECIPE_ID)
    REFERENCES RECIPES(RECIPE_ID) ON DELETE CASCADE,
  CONSTRAINT FK_REVIEW_MEMBER FOREIGN KEY (MEMBER_NO)
    REFERENCES MEMBERS(MEMBER_NO) ON DELETE CASCADE
);

CREATE TABLE MARTS (
  MART_ID   NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  NAME      VARCHAR2(100) NOT NULL,
  LOCATION  VARCHAR2(200),
  STATUS    VARCHAR2(20) DEFAULT 'ACTIVE'
);

CREATE TABLE MART_INTEGRATIONS (
  INTEGRATION_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  MEMBER_NO      NUMBER NOT NULL,
  MART_NAME      VARCHAR2(50) NOT NULL,
  MART_USER_ID   VARCHAR2(255) NOT NULL,
  API_TOKEN      VARCHAR2(1000),
  IS_ACTIVE      CHAR(1) DEFAULT 'Y' CHECK(IS_ACTIVE IN ('Y', 'N')),
  CREATED_AT     TIMESTAMP DEFAULT SYSTIMESTAMP,
  UPDATED_AT     TIMESTAMP DEFAULT SYSTIMESTAMP,
  CONSTRAINT FK_MART_MEMBER FOREIGN KEY (MEMBER_NO)
    REFERENCES MEMBERS(MEMBER_NO) ON DELETE CASCADE
);

-------------------------------------------------------------------------------
-- 2) Seed data
-------------------------------------------------------------------------------

-- member: user_id=test, pw=1234 (SHA-256)
INSERT INTO MEMBERS (NAME, USER_ID, PASSWORD_HASH, EMAIL, PHONE, GENDER, POINTS)
VALUES ('테스트사용자', 'test', '03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4',
        'test@example.com', '010-0000-0000', 'M', 100);

-- marts
INSERT INTO MARTS (NAME, LOCATION, STATUS) VALUES ('CookPick Mart', 'Seoul', 'ACTIVE');
INSERT INTO MARTS (NAME, LOCATION, STATUS) VALUES ('Fresh Mart', 'Busan', 'ACTIVE');

-- ingredients
INSERT INTO INGREDIENTS (NAME, CATEGORY) VALUES ('계란', '유제품/달걀');
INSERT INTO INGREDIENTS (NAME, CATEGORY) VALUES ('대파', '채소');
INSERT INTO INGREDIENTS (NAME, CATEGORY) VALUES ('토마토', '채소');
INSERT INTO INGREDIENTS (NAME, CATEGORY) VALUES ('마늘', '향신료');
INSERT INTO INGREDIENTS (NAME, CATEGORY) VALUES ('우유', '유제품');
INSERT INTO INGREDIENTS (NAME, CATEGORY) VALUES ('소금', '조미료');
INSERT INTO INGREDIENTS (NAME, CATEGORY) VALUES ('간장', '조미료');
INSERT INTO INGREDIENTS (NAME, CATEGORY) VALUES ('설탕', '조미료');
INSERT INTO INGREDIENTS (NAME, CATEGORY) VALUES ('돼지고기', '육류');
INSERT INTO INGREDIENTS (NAME, CATEGORY) VALUES ('소고기', '육류');

-- grab ids and insert fridge items
DECLARE
  v_member NUMBER;
  v_tomato NUMBER;
  v_egg    NUMBER;
  v_milk   NUMBER;
BEGIN
  SELECT MEMBER_NO INTO v_member FROM MEMBERS WHERE USER_ID='test';
  SELECT INGREDIENT_ID INTO v_tomato FROM INGREDIENTS WHERE NAME='토마토';
  SELECT INGREDIENT_ID INTO v_egg    FROM INGREDIENTS WHERE NAME='계란';
  SELECT INGREDIENT_ID INTO v_milk   FROM INGREDIENTS WHERE NAME='우유';

  INSERT INTO REFRIGERATOR_ITEMS (MEMBER_NO, INGREDIENT_ID, QUANTITY, PURCHASE_DATE, EXPIRATION_DATE, IS_EXPIRATION_UNKNOWN)
  VALUES (v_member, v_tomato, '2개', TRUNC(SYSDATE)-1, TRUNC(SYSDATE)+5, 'N');
  INSERT INTO REFRIGERATOR_ITEMS (MEMBER_NO, INGREDIENT_ID, QUANTITY, PURCHASE_DATE, EXPIRATION_DATE, IS_EXPIRATION_UNKNOWN)
  VALUES (v_member, v_egg, '10개', TRUNC(SYSDATE)-2, TRUNC(SYSDATE)+10, 'N');
  INSERT INTO REFRIGERATOR_ITEMS (MEMBER_NO, INGREDIENT_ID, QUANTITY, PURCHASE_DATE, EXPIRATION_DATE, IS_EXPIRATION_UNKNOWN)
  VALUES (v_member, v_milk, '1개', TRUNC(SYSDATE)-1, TRUNC(SYSDATE)+7, 'N');
END;
/

-- sample recipe: 토마토 스크램블
DECLARE
  v_member NUMBER;
  v_recipe NUMBER;
  v_tomato NUMBER;
  v_egg    NUMBER;
BEGIN
  SELECT MEMBER_NO INTO v_member FROM MEMBERS WHERE USER_ID='test';

  INSERT INTO RECIPES (AUTHOR_NO, TITLE, DESCRIPTION, MAIN_IMAGE_URL)
  VALUES (v_member, '토마토 스크램블', '토마토와 계란으로 만드는 간단한 스크램블',
          'https://picsum.photos/seed/tomato/400/300')
  RETURNING RECIPE_ID INTO v_recipe;

  SELECT INGREDIENT_ID INTO v_tomato FROM INGREDIENTS WHERE NAME='토마토';
  SELECT INGREDIENT_ID INTO v_egg    FROM INGREDIENTS WHERE NAME='계란';

  INSERT INTO RECIPE_INGREDIENTS (RECIPE_ID, INGREDIENT_ID, REQUIRED_QUANTITY)
  VALUES (v_recipe, v_tomato, '1~2개');
  INSERT INTO RECIPE_INGREDIENTS (RECIPE_ID, INGREDIENT_ID, REQUIRED_QUANTITY)
  VALUES (v_recipe, v_egg, '2개');

  INSERT INTO RECIPE_STEPS (RECIPE_ID, STEP_NUMBER, INSTRUCTION)
  VALUES (v_recipe, 1, '토마토는 깍둑 썬다.');
  INSERT INTO RECIPE_STEPS (RECIPE_ID, STEP_NUMBER, INSTRUCTION)
  VALUES (v_recipe, 2, '계란을 풀어 스크램블한다.');
  INSERT INTO RECIPE_STEPS (RECIPE_ID, STEP_NUMBER, INSTRUCTION)
  VALUES (v_recipe, 3, '팬에 토마토와 스크램블을 섞어 간을 맞춘다.');
END;
/

-- sample review + update avg rating
INSERT INTO REVIEWS (RECIPE_ID, MEMBER_NO, RATING, COMMENT_TEXT)
SELECT r.RECIPE_ID, m.MEMBER_NO, 4.5, '간단하고 맛있어요!'
FROM RECIPES r CROSS JOIN MEMBERS m
WHERE r.TITLE='토마토 스크램블' AND m.USER_ID='test';

UPDATE RECIPES r
SET AVG_RATING = (SELECT ROUND(AVG(RATING),1) FROM REVIEWS v WHERE v.RECIPE_ID = r.RECIPE_ID)
WHERE r.TITLE='토마토 스크램블';

COMMIT;
